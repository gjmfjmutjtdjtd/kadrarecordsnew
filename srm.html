<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Полная CRM-система</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">

    <!-- Боковая панель (навигация) -->
    <div id="sidebar" class="bg-gray-800 text-white w-64 md:w-64 flex-shrink-0 flex flex-col transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 fixed md:static inset-y-0 left-0 z-50">
        <div class="p-6">
            <h1 class="text-2xl font-bold">CRM 2.0</h1>
            <p class="text-gray-400 text-sm">Полная версия</p>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="#" data-nav-link="dashboard" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Панель</span>
            </a>
            <a href="#" data-nav-link="contacts" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h-1a1 1 0 00-1 1v1a1 1 0 001 1h1a1 1 0 001-1v-1a1 1 0 00-1-1zm-6 0h-1a1 1 0 00-1 1v1a1 1 0 001 1h1a1 1 0 001-1v-1a1 1 0 00-1-1zm-6 0h-1a1 1 0 00-1 1v1a1 1 0 001 1h1a1 1 0 001-1v-1a1 1 0 00-1-1z" />
                </svg>
                <span>Контакты</span>
            </a>
            <a href="#" data-nav-link="deals" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 0v10m0-10l-3 3m3-3l3 3m-3-3l-3 3" />
                </svg>
                <span>Сделки</span>
            </a>
            <a href="#" data-nav-link="tasks" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2m0 0l2-2m-2 2V9" />
                </svg>
                <span>Задачи</span>
            </a>
            <a href="#" data-nav-link="analytics" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                <span>Аналитика</span>
            </a>
            <a href="#" data-nav-link="gemini-seller" class="flex items-center space-x-2 p-3 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.18 0-6.248-.564-9-1.745M16 18V9.303A4.253 4.253 0 0012 5a4.253 4.253 0 00-4 4.303V18m8-4.5c0 .414-.16.804-.44 1.1c-.28.296-.65.462-1.06.462s-.78-.166-1.06-.462c-.28-.296-.44-.686-.44-1.1h3.003z" />
                </svg>
                <span>Gemini Продавец</span>
            </a>
        </nav>
    </div>

    <!-- Основной контент -->
    <div class="flex-1 flex flex-col min-h-screen">
        <!-- Кнопка мобильного меню -->
        <button id="mobile-menu-btn" class="md:hidden p-4 text-gray-800 focus:outline-none">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
            </svg>
        </button>
        
        <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
            <!-- Панель управления -->
            <div data-view="dashboard" class="space-y-6">
                <h2 class="text-3xl font-bold text-gray-800">Панель управления</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-500">Сделок в работе</h3>
                        <p id="deals-in-progress" class="mt-1 text-4xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-500">Задач на сегодня</h3>
                        <p id="tasks-for-today" class="mt-1 text-4xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-lg font-medium text-gray-500">Новых клиентов</h3>
                        <p id="new-clients" class="mt-1 text-4xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
                <!-- Задачи и сделки на панели -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Предстоящие задачи</h3>
                        <div id="dashboard-tasks-list" class="space-y-4"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Последние сделки</h3>
                        <div id="dashboard-deals-list" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Раздел контактов -->
            <div data-view="contacts" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Контакты</h2>
                    <button id="add-contact-btn" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 transition-colors duration-200 font-medium">Добавить контакт</button>
                </div>
                <div id="contacts-list-container" class="space-y-4"></div>
            </div>

            <!-- Раздел сделок -->
            <div data-view="deals" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Сделки</h2>
                    <button id="add-deal-btn" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 transition-colors duration-200 font-medium">Добавить сделку</button>
                </div>
                <div id="deals-kanban-board" class="flex flex-wrap md:flex-nowrap gap-4 md:space-x-4 overflow-x-auto p-2"></div>
            </div>

            <!-- Раздел задач -->
            <div data-view="tasks" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Задачи</h2>
                    <button id="add-task-btn" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700 transition-colors duration-200 font-medium">Добавить задачу</button>
                </div>
                <div id="tasks-list" class="space-y-4"></div>
            </div>

            <!-- Раздел аналитики -->
            <div data-view="analytics" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Аналитика</h2>
                <div id="analytics-content" class="space-y-6"></div>
            </div>
            
            <!-- Gemini Продавец -->
            <div data-view="gemini-seller" class="hidden h-full flex flex-col">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Gemini Продавец</h2>
                <div id="chat-box" class="flex-1 overflow-y-auto p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col space-y-4">
                    <!-- Приветственное сообщение -->
                    <div class="flex justify-start">
                        <div class="bg-blue-100 text-gray-800 p-4 rounded-3xl max-w-[80%]">
                            <p>Привет! Я твой личный помощник по продажам. Задай мне любой вопрос.</p>
                        </div>
                    </div>
                </div>
                <form id="chat-form" class="mt-4 flex items-center space-x-2">
                    <input type="text" name="message" id="chat-input" placeholder="Введите ваш вопрос..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" id="send-button" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-6 h-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
                <div id="loading-indicator" class="hidden mt-2 text-center text-gray-500">
                    <p>Помощник думает...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 md:p-8 max-w-lg w-full relative">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h3>
            <div id="modal-content"></div>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
    </div>
    
    <!-- Скрипты -->
    <script>
        const LOCAL_STORAGE_KEY = 'full-crm-data';

        const state = {
            activeView: 'dashboard',
            contacts: [],
            deals: [],
            tasks: [],
            chatHistory: []
        };

        const views = document.querySelectorAll('[data-view]');
        const navButtons = document.querySelectorAll('[data-nav-link]');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loadingIndicator = document.getElementById('loading-indicator');
        const sendButton = document.getElementById('send-button');

        // Локальное хранилище
        const saveData = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        };

        const loadData = () => {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (data) {
                const loadedState = JSON.parse(data);
                Object.assign(state, loadedState);
            }
        };

        // UI-управление
        const switchView = (viewName) => {
            state.activeView = viewName;
            views.forEach(view => {
                view.classList.add('hidden');
                if (view.dataset.view === viewName) {
                    view.classList.remove('hidden');
                }
            });
            navButtons.forEach(button => {
                const link = button.closest('a');
                link.classList.remove('bg-gray-700', 'text-white');
                link.classList.add('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                if (link.dataset.navLink === viewName) {
                    link.classList.add('bg-gray-700', 'text-white');
                    link.classList.remove('text-gray-300', 'hover:bg-gray-700', 'hover:text-white');
                }
            });
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
            renderViews();
        };

        const openModal = (title, contentHTML) => {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHTML;
            modal.classList.remove('hidden');
        };

        const closeModal = () => {
            modal.classList.add('hidden');
        };

        // Функции рендеринга
        const renderDashboard = () => {
            document.getElementById('deals-in-progress').textContent = state.deals.length;
            document.getElementById('tasks-for-today').textContent = state.tasks.filter(t => !t.isCompleted).length;
            document.getElementById('new-clients').textContent = state.contacts.length; // Simplified for this version
            
            const taskContainer = document.getElementById('dashboard-tasks-list');
            taskContainer.innerHTML = '';
            state.tasks.slice(0, 3).forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200';
                taskEl.innerHTML = `<h4 class="font-medium">${task.title}</h4><p class="text-sm text-gray-500">Срок: ${task.dueDate}</p>`;
                taskContainer.appendChild(taskEl);
            });

            const dealContainer = document.getElementById('dashboard-deals-list');
            dealContainer.innerHTML = '';
            state.deals.slice(0, 3).forEach(deal => {
                const contact = state.contacts.find(c => c.id === deal.contactId);
                const dealEl = document.createElement('div');
                dealEl.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200';
                dealEl.innerHTML = `<h4 class="font-medium">${deal.title}</h4><p class="text-sm text-gray-500">Клиент: ${contact ? contact.name : 'Неизвестно'}</p><p class="text-sm text-green-600 font-bold">₽ ${deal.amount.toLocaleString()}</p>`;
                dealContainer.appendChild(dealEl);
            });
        };

        const renderContacts = () => {
            const container = document.getElementById('contacts-list-container');
            container.innerHTML = '';
            if (state.contacts.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">У вас еще нет контактов.</p>';
                return;
            }
            state.contacts.forEach(contact => {
                const contactEl = document.createElement('div');
                contactEl.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                contactEl.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg">${contact.name}</h3>
                        <p class="text-gray-600 text-sm">Email: ${contact.email || 'Не указан'}</p>
                        <p class="text-gray-600 text-sm">Телефон: ${contact.phone || 'Не указан'}</p>
                    </div>
                    <div class="mt-4 sm:mt-0 flex-shrink-0 space-x-2">
                        <button class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-yellow-600 edit-contact-btn" data-id="${contact.id}">Редактировать</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 delete-contact-btn" data-id="${contact.id}">Удалить</button>
                    </div>
                `;
                container.appendChild(contactEl);
            });
        };

        const renderDeals = () => {
            const stages = ['Новая', 'Квалификация', 'Предложение', 'Переговоры', 'Выиграна', 'Проиграна'];
            const container = document.getElementById('deals-kanban-board');
            container.innerHTML = '';
            stages.forEach(stage => {
                const stageContainer = document.createElement('div');
                stageContainer.className = 'bg-gray-200 p-4 rounded-xl shadow-inner min-w-[280px] flex-1';
                stageContainer.innerHTML = `<h3 class="font-semibold text-center mb-4 text-gray-700">${stage}</h3>`;
                stageContainer.dataset.stage = stage;
                stageContainer.ondragover = (e) => e.preventDefault();
                stageContainer.ondrop = (e) => {
                    e.preventDefault();
                    const dealId = e.dataTransfer.getData('text/plain');
                    const newStage = e.target.closest('[data-stage]').dataset.stage;
                    updateDealStage(dealId, newStage);
                };
                const dealsInStage = state.deals.filter(deal => deal.stage === stage);
                dealsInStage.forEach(deal => {
                    const contact = state.contacts.find(c => c.id === deal.contactId);
                    const dealEl = document.createElement('div');
                    dealEl.className = 'bg-white p-3 rounded-lg shadow-sm mb-2 cursor-pointer border border-gray-200';
                    dealEl.draggable = true;
                    dealEl.dataset.id = deal.id;
                    dealEl.ondragstart = (e) => e.dataTransfer.setData('text/plain', e.target.dataset.id);
                    dealEl.innerHTML = `
                        <h4 class="font-semibold text-sm truncate">${deal.title}</h4>
                        <p class="text-xs text-gray-500 truncate">${contact ? contact.name : 'Контакт не найден'}</p>
                        <p class="text-xs text-green-600 font-bold mt-1">₽ ${deal.amount.toLocaleString()}</p>
                    `;
                    stageContainer.appendChild(dealEl);
                });
                container.appendChild(stageContainer);
            });
        };

        const renderTasks = () => {
            const container = document.getElementById('tasks-list');
            container.innerHTML = '';
            if (state.tasks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">У вас нет задач.</p>';
                return;
            }
            state.tasks.forEach(task => {
                const taskEl = document.createElement('div');
                const isCompletedClass = task.isCompleted ? 'line-through text-gray-500' : 'text-gray-800';
                taskEl.className = `flex items-center justify-between bg-white p-4 mb-2 rounded-xl shadow-sm border border-gray-200`;
                taskEl.innerHTML = `
                    <div class="flex-1">
                        <h4 class="font-medium text-sm ${isCompletedClass}">${task.title}</h4>
                        <p class="text-xs text-gray-400 mt-1">Срок: ${task.dueDate}</p>
                    </div>
                    <input type="checkbox" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300" ${task.isCompleted ? 'checked' : ''} data-id="${task.id}" data-task-checkbox>
                `;
                container.appendChild(taskEl);
            });
        };

        const renderAnalytics = () => {
            const analyticsContainer = document.getElementById('analytics-content');
            analyticsContainer.innerHTML = '';
            const stages = ['Новая', 'Квалификация', 'Предложение', 'Переговоры', 'Выиграна', 'Проиграна'];
            const dealsByStage = stages.map(stage => state.deals.filter(deal => deal.stage === stage).length);
            const totalDeals = state.deals.length;

            const analyticsHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-md">
                    <h3 class="text-lg font-bold mb-4">Воронка продаж</h3>
                    <div class="flex flex-col space-y-4 p-4">
                        ${stages.map((stage, index) => {
                            const count = dealsByStage[index];
                            const percentage = totalDeals > 0 ? (count / totalDeals) * 100 : 0;
                            return `
                                <div class="flex items-center">
                                    <span class="w-32 text-sm text-gray-600">${stage}</span>
                                    <div class="flex-1 h-6 bg-blue-100 rounded-lg overflow-hidden">
                                        <div class="h-full bg-blue-500 rounded-lg transition-all duration-500 ease-in-out" style="width: ${percentage}%;"></div>
                                    </div>
                                    <span class="w-16 ml-4 text-right font-semibold text-gray-800">${count}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            analyticsContainer.innerHTML = analyticsHTML;
        };
        
        const renderChat = () => {
            chatBox.innerHTML = '';
            if (state.chatHistory.length === 0) {
                const welcomeMessage = `
                    <div class="flex justify-start">
                        <div class="bg-blue-100 text-gray-800 p-4 rounded-3xl max-w-[80%]">
                            <p>Привет! Я твой личный помощник по продажам. Задай мне любой вопрос.</p>
                        </div>
                    </div>
                `;
                chatBox.innerHTML = welcomeMessage;
            } else {
                state.chatHistory.forEach(msg => addMessageToChat(msg.text, msg.sender));
            }
        };

        const renderViews = () => {
            renderDashboard();
            renderContacts();
            renderDeals();
            renderTasks();
            renderAnalytics();
            renderChat();
        };

        // Логика чат-бота
        const addMessageToChat = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            messageDiv.innerHTML = `
                <div class="${sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-800'} p-4 rounded-3xl max-w-[80%]">
                    <p>${text}</p>
                </div>
            `;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };
        
        const sendMessageToGemini = async (userMessage) => {
            const systemPrompt = "Ты опытный помощник по продажам. Твоя задача — давать полезные советы, помогать в общении с клиентами, предлагать тактики и отрабатывать возражения. Отвечай кратко, по делу и в дружелюбном, профессиональном тоне.";
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userMessage }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    addMessageToChat(text, 'assistant');
                    state.chatHistory.push({ text: userMessage, sender: 'user' });
                    state.chatHistory.push({ text, sender: 'assistant' });
                    saveData();
                } else {
                    addMessageToChat("Извините, произошла ошибка. Пожалуйста, попробуйте еще раз.", 'assistant');
                }
            } catch (error) {
                console.error('Ошибка при обращении к API:', error);
                addMessageToChat("Извините, произошла ошибка. Пожалуйста, попробуйте еще раз.", 'assistant');
            } finally {
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
            }
        };
        
        // CRUD операции с данными (локальное хранилище)
        const addContact = (contact) => {
            contact.id = Date.now();
            state.contacts.push(contact);
            saveData();
            renderViews();
        };

        const updateContact = (id, updatedData) => {
            const index = state.contacts.findIndex(c => c.id === id);
            if (index !== -1) {
                state.contacts[index] = { ...state.contacts[index], ...updatedData };
                saveData();
                renderViews();
            }
        };

        const deleteContact = (id) => {
            state.contacts = state.contacts.filter(c => c.id !== id);
            state.deals = state.deals.filter(d => d.contactId !== id); // Удалить связанные сделки
            state.tasks = state.tasks.filter(t => t.contactId !== id); // Удалить связанные задачи
            saveData();
            renderViews();
        };

        const addDeal = (deal) => {
            deal.id = Date.now();
            deal.stage = 'Новая';
            state.deals.push(deal);
            saveData();
            renderViews();
        };

        const updateDealStage = (id, newStage) => {
            const deal = state.deals.find(d => d.id == id);
            if (deal) {
                deal.stage = newStage;
                saveData();
                renderViews();
            }
        };

        const addTask = (task) => {
            task.id = Date.now();
            task.isCompleted = false;
            state.tasks.push(task);
            saveData();
            renderViews();
        };
        
        const updateTaskStatus = (id, isCompleted) => {
            const task = state.tasks.find(t => t.id == id);
            if (task) {
                task.isCompleted = isCompleted;
                saveData();
                renderViews();
            }
        };

        // Генераторы форм для модальных окон
        const showAddContactModal = () => {
            const formHTML = `
                <form id="contact-form" class="space-y-4">
                    <input type="text" name="name" placeholder="Имя/Компания" required class="w-full p-2 border rounded-md">
                    <input type="email" name="email" placeholder="Email" class="w-full p-2 border rounded-md">
                    <input type="tel" name="phone" placeholder="Телефон" class="w-full p-2 border rounded-md">
                    <div class="flex justify-between items-center space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="w-1/2 bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Сохранить</button>
                    </div>
                </form>
            `;
            openModal('Добавить контакт', formHTML);
        };
        
        const showEditContactModal = (id) => {
            const contact = state.contacts.find(c => c.id === id);
            if (!contact) return;
            const formHTML = `
                <form id="contact-form" class="space-y-4" data-id="${contact.id}">
                    <input type="text" name="name" value="${contact.name}" placeholder="Имя/Компания" required class="w-full p-2 border rounded-md">
                    <input type="email" name="email" value="${contact.email || ''}" placeholder="Email" class="w-full p-2 border rounded-md">
                    <input type="tel" name="phone" value="${contact.phone || ''}" placeholder="Телефон" class="w-full p-2 border rounded-md">
                    <div class="flex justify-between items-center space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="w-1/2 bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Обновить</button>
                    </div>
                </form>
            `;
            openModal('Редактировать контакт', formHTML);
        };
        
        const showAddDealModal = () => {
            const contactsOptions = state.contacts.map(contact => `<option value="${contact.id}">${contact.name}</option>`).join('');
            const formHTML = `
                <form id="deal-form" class="space-y-4">
                    <input type="text" name="title" placeholder="Название сделки" required class="w-full p-2 border rounded-md">
                    <select name="contactId" class="w-full p-2 border rounded-md" required>
                        <option value="">Выберите контакт...</option>
                        ${contactsOptions}
                    </select>
                    <input type="number" name="amount" placeholder="Сумма" required class="w-full p-2 border rounded-md">
                    <label class="block text-sm text-gray-700">Предполагаемая дата закрытия:</label>
                    <input type="date" name="expectedCloseDate" required class="w-full p-2 border rounded-md">
                    <div class="flex justify-between items-center space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="w-1/2 bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Сохранить</button>
                    </div>
                </form>
            `;
            openModal('Добавить сделку', formHTML);
        };
        
        const showAddTaskModal = () => {
            const contactsOptions = state.contacts.map(contact => `<option value="${contact.id}">${contact.name}</option>`).join('');
            const formHTML = `
                <form id="task-form" class="space-y-4">
                    <input type="text" name="title" placeholder="Заголовок задачи" required class="w-full p-2 border rounded-md">
                    <textarea name="description" placeholder="Описание задачи" class="w-full p-2 border rounded-md"></textarea>
                    <label class="block text-sm text-gray-700">Срок выполнения:</label>
                    <input type="date" name="dueDate" required class="w-full p-2 border rounded-md">
                    <select name="contactId" class="w-full p-2 border rounded-md">
                        <option value="">Без привязки к клиенту</option>
                        ${contactsOptions}
                    </select>
                    <div class="flex justify-between items-center space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="w-1/2 bg-gray-300 text-gray-800 p-2 rounded-md hover:bg-gray-400">Отмена</button>
                        <button type="submit" class="w-1/2 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Сохранить</button>
                    </div>
                </form>
            `;
            openModal('Добавить задачу', formHTML);
        };

        // Обработчики событий
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('[data-nav-link]');
            if (navLink) {
                switchView(navLink.dataset.navLink);
                return;
            }

            const deleteContactBtn = e.target.closest('.delete-contact-btn');
            if (deleteContactBtn) {
                const id = parseInt(deleteContactBtn.dataset.id, 10);
                deleteContact(id);
                return;
            }

            const editContactBtn = e.target.closest('.edit-contact-btn');
            if (editContactBtn) {
                const id = parseInt(editContactBtn.dataset.id, 10);
                showEditContactModal(id);
                return;
            }

            if (e.target.id === 'close-modal-btn') {
                closeModal();
            } else if (e.target.id === 'add-contact-btn') {
                showAddContactModal();
            } else if (e.target.id === 'add-deal-btn') {
                showAddDealModal();
            } else if (e.target.id === 'add-task-btn') {
                showAddTaskModal();
            } else if (e.target.id === 'mobile-menu-btn') {
                sidebar.classList.toggle('-translate-x-full');
            }
        });

        document.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            if (form.id === 'contact-form') {
                const contactId = form.dataset.id;
                if (contactId) {
                    updateContact(parseInt(contactId, 10), data);
                } else {
                    addContact(data);
                }
                closeModal();
            } else if (form.id === 'deal-form') {
                data.amount = parseFloat(data.amount);
                addDeal(data);
                closeModal();
            } else if (form.id === 'task-form') {
                addTask(data);
                closeModal();
            } else if (form.id === 'chat-form') {
                const userMessage = data.message;
                addMessageToChat(userMessage, 'user');
                loadingIndicator.classList.remove('hidden');
                sendButton.disabled = true;
                form.reset();
                sendMessageToGemini(userMessage);
            }
        });

        document.addEventListener('change', (e) => {
            const taskCheckbox = e.target.closest('[data-task-checkbox]');
            if (taskCheckbox) {
                const taskId = parseInt(taskCheckbox.dataset.id, 10);
                updateTaskStatus(taskId, taskCheckbox.checked);
            }
        });

        // Инициализация
        window.onload = () => {
            loadData();
            switchView(state.activeView);
        };
    </script>
</body>
</html>
