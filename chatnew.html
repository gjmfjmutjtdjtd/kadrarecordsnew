<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Простой Чат</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles can go here if needed, but Tailwind is preferred */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .chat-container {
            width: 100%;
            max-width: 480px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 80vh; /* Adjust height for better mobile experience */
            max-height: 720px;
        }
        .chat-header {
            background-color: #4f46e5;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            position: relative; /* For userIdDisplay positioning */
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #e2e8f0;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        .message-bubble.sent {
            background-color: #a78bfa;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .message-bubble.received {
            background-color: #ffffff;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
        .message-author {
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: rgba(255, 255, 255, 0.8);
        }
        .message-bubble.received .message-author {
            color: #6b7280;
        }
        .message-timestamp {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
            margin-top: 0.25rem;
        }
        .message-bubble.received .message-timestamp {
            color: #9ca3af;
        }
        .chat-input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }
        .chat-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            margin-right: 0.75rem;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }
        .chat-input:focus {
            border-color: #4f46e5;
        }
        .chat-send-btn {
            background-color: #4f46e5;
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-send-btn:hover {
            background-color: #4338ca;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .chat-container {
                width: 95%;
                height: 90vh;
            }
        }

        /* Message Box for alerts */
        #messageBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none; /* Hidden by default */
            font-family: 'Inter', sans-serif;
        }
        #userIdDisplay {
            font-size: 0.7rem;
            color: #e0e7ff;
            margin-top: 0.5rem;
            word-break: break-all; /* Allow long user IDs to break to new line */
            padding: 0 1rem;
            text-align: left; /* Align to left within header */
        }
        #authSection {
            width: 100%;
            max-width: 480px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #authSection button {
            width: 100%;
            max-width: 250px;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.75rem;
        }
        #authSection button:last-child {
            margin-bottom: 0;
        }
        #authSection button.google-btn {
            background-color: #db4437; /* Google Red */
            color: #ffffff;
        }
        #authSection button.google-btn:hover {
            background-color: #c23321;
            transform: scale(1.02);
        }
        #authSection button.anon-btn {
            background-color: #4f46e5; /* Indigo Blue */
            color: #ffffff;
        }
        #authSection button.anon-btn:hover {
            background-color: #4338ca;
            transform: scale(1.02);
        }
    </style>
</head>
<body>

    <div id="authSection" class="flex flex-col items-center justify-center hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Авторизация</h2>
        <button id="googleSignInBtn" class="google-btn">
            Войти через Google
        </button>
        <button id="anonymousSignInBtn" class="anon-btn">
            Войти анонимно
        </button>
    </div>

    <div class="chat-container hidden" id="chatContainer">
        <div class="chat-header">
            Простой Чат
            <div id="userIdDisplay"></div>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="messageInput" class="chat-input" placeholder="Введите ваше сообщение...">
            <button id="sendBtn" class="chat-send-btn">Отправить</button>
        </div>
    </div>

    <div id="messageBox" role="alert"></div>

    <script type="module">
        // Firebase configuration (empty for now, will be populated by Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null; // Store the current user's ID
        let userName = null; // Store a user-friendly name

        // Display a message box instead of alert()
        function showMessageBox(message, type = 'error', duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';

            if (type === 'error') {
                messageBox.style.backgroundColor = '#f8d7da';
                messageBox.style.color = '#721c24';
            } else if (type === 'success') {
                messageBox.style.backgroundColor = '#d4edda';
                messageBox.style.color = '#155724';
            } else {
                messageBox.style.backgroundColor = '#d1ecf1';
                messageBox.style.color = '#0c5460';
            }

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // --- Frontend JavaScript ---
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        const authSection = document.getElementById('authSection');
        const chatContainer = document.getElementById('chatContainer');
        const googleSignInBtn = document.getElementById('googleSignInBtn');
        const anonymousSignInBtn = document.getElementById('anonymousSignInBtn');


        // Function to display messages in the chat interface
        function displayMessage(message, isSent) {
            const messageBubble = document.createElement('div');
            messageBubble.classList.add('message-bubble');
            messageBubble.classList.add(isSent ? 'sent' : 'received');

            const authorSpan = document.createElement('span');
            authorSpan.classList.add('message-author');
            authorSpan.textContent = message.author || 'Неизвестный'; // Fallback for author

            const contentDiv = document.createElement('div');
            contentDiv.textContent = message.text;

            const timestampSpan = document.createElement('span');
            timestampSpan.classList.add('message-timestamp');
            const date = message.timestamp && message.timestamp.toDate ? message.timestamp.toDate() : new Date();
            timestampSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageBubble.appendChild(authorSpan);
            messageBubble.appendChild(contentDiv);
            messageBubble.appendChild(timestampSpan);
            chatMessages.appendChild(messageBubble);

            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        // Function to load messages from Firestore
        function setupMessageListener() {
            if (!currentUserId) {
                console.warn("User not authenticated yet, cannot set up message listener.");
                return;
            }

            // Public chat collection path
            const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
            const q = query(messagesCollectionRef);

            onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = ''; // Clear existing messages
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push(doc.data());
                });

                // Sort messages by timestamp if not already sorted by query
                messages.sort((a, b) => (a.timestamp && b.timestamp) ? a.timestamp.toDate() - b.timestamp.toDate() : 0);

                messages.forEach(msg => {
                    const isSent = msg.userId === currentUserId;
                    displayMessage(msg, isSent);
                });
            }, (error) => {
                console.error('Ошибка при загрузке сообщений из Firestore:', error);
                showMessageBox('Ошибка при загрузке сообщений: ' + error.message, 'error');
            });
        }

        // Function to send a message to Firestore
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText === '') {
                return; // Don't send empty messages
            }
            if (!currentUserId) {
                showMessageBox('Пользователь не аутентифицирован. Попробуйте еще раз.', 'error');
                return;
            }

            try {
                // Public chat collection path
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                await addDoc(messagesCollectionRef, {
                    author: userName,
                    text: messageText,
                    timestamp: serverTimestamp(),
                    userId: currentUserId
                });
                messageInput.value = ''; // Clear input field
            } catch (error) {
                console.error('Ошибка при отправке сообщения в Firestore:', error);
                showMessageBox('Ошибка при отправке сообщения: ' + error.message, 'error');
            }
        }

        // Event listeners for chat input and send button
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Firebase Authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("onAuthStateChanged: Пользователь вошел в систему.", user.uid);
                currentUserId = user.uid;
                userName = `AnonUser_${currentUserId.substring(0, 8)}`; // Generate a simple username
                userIdDisplay.textContent = `Ваш ID: ${currentUserId}`;
                authSection.classList.add('hidden'); // Hide auth section
                chatContainer.classList.remove('hidden'); // Show chat container
                setupMessageListener(); // Start listening for messages once authenticated
                showMessageBox('Вы вошли в чат как ' + userName, 'success');
            } else {
                console.log("onAuthStateChanged: Пользователь не вошел в систему.");
                // User is not logged in, show authentication options
                authSection.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                currentUserId = null;
                userName = null;
                userIdDisplay.textContent = '';
                showMessageBox('Пожалуйста, войдите в свой аккаунт.', 'info');
            }
        });

        // Event listeners for authentication buttons
        anonymousSignInBtn.addEventListener('click', async () => {
            console.log("Нажата кнопка анонимного входа.");
            try {
                await signInAnonymously(auth);
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error("Ошибка анонимной аутентификации:", error);
                showMessageBox("Ошибка анонимной аутентификации: " + error.message, "error");
            }
        });

        googleSignInBtn.addEventListener('click', () => {
            console.log("Нажата кнопка входа через Google.");
            showMessageBox("Вход через Google не реализован в этой версии чата.", "info");
            // In a real application, you would implement Google sign-in here.
            // Example: signInWithPopup(auth, new GoogleAuthProvider());
        });

        // Initial setup to try custom token login if available
        window.onload = async function() {
            if (initialAuthToken) {
                console.log("window.onload: Попытка входа с пользовательским токеном.");
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    // onAuthStateChanged will handle success
                } catch (error) {
                    console.error("window.onload: Ошибка аутентификации с токеном:", error);
                    showMessageBox("Ошибка аутентификации с токеном. Пожалуйста, войдите анонимно.", "error");
                    // onAuthStateChanged will then fire with user=null, showing authSection
                }
            } else {
                console.log("window.onload: Пользовательский токен аутентификации недоступен.");
                // If no initialAuthToken, onAuthStateChanged will eventually fire with null user
                // and show the authSection, letting the user choose.
            }
        };
    </script>
</body>
</html>
